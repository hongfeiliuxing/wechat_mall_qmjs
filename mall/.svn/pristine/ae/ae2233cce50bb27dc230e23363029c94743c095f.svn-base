var mySwiper = new Swiper('.swiper-container', {
	// loop:false,
	// slidesPerView :'auto',
	// loopedSlides :7,
	// longSwipes : false,
	width: 40,
	freeMode: true,
	noSwiping: true,
})
//全局变量
var pageNo = 0;
var pageSize = 10;
// 刷新相关
var $content = null;
var loading = false;
//订单状态
var orderStatus = '';
//订单退货状态
var cancelStatus = '';
//tab切换相关
var preTabId = $("#all").attr("id");;

function openIndicator() {
	$.showIndicator();
	isIndicator = true;
}

function hideIndicator() {
	if (isIndicator) {
		$.hideIndicator();
		isIndicator = false;
	}
	loading = false;
}


$(document).ready(function () {

	
	// 校验openid
	var openId = getLocalSession("openid") || "";
	var custId = getLocalSession("custId") || "";
	if (openId == ""||custId=="") {
		$.toast("未获取到用户资料，无法访问");
		xhq.gotoErrorPage();
		return;
	}

	//注册下拉刷新页面
	$(document).on("pageInit", "#page-ptr", function (e, id, page) {
		$content = $(page).find(".content-block");

		$(page).on('infinite', function (e) {
			if (loading) return;
			openIndicator();
			loading = true;
			setTimeout(function () {
				isAppendMode = 1;
				loadData();
				$.refreshScroller();
			}, 1000);
		});
	});

	//	$("#tabContent").on('tap','li',function(){
	//		var onlineId = $(this).attr("orderId");
	//		xhq.gotoUrl("order_detail.html",{orderId:orderId});
	//	});

	// 注册tab切换事件
	$(".swiper-slide").on('tap', function (e) {
		var curtabid = $(this).attr("id");
		var reload = 0;

		if (curtabid != preTabId) {
			// tab切换了，需要重新加载
			if (curtabid == "all") {
				orderStatus = '';
				cancelStatus = '';
			} else if (curtabid == "waitPay") {
				orderStatus = 1;
				cancelStatus = 1;
			} else if (curtabid == "waitDeliver") {
				orderStatus = 2;
				cancelStatus = 1;
			} else if (curtabid == "deliver") {
				orderStatus = 4;
				cancelStatus = 1;
			} else if (curtabid == "finish") {
				orderStatus = 5;
				cancelStatus = 1;
			} else if(curtabid == "close"){
				orderStatus = 6;
				cancelStatus = 1;
			}else if(curtabid == "refund"){
				orderStatus = '';
				cancelStatus = 3;
			}
			reload = 1;

			$("#" + preTabId).removeClass("active")
			$(this).addClass("active");
			preTabId = curtabid;
		}

		if (reload == 1) {
			openIndicator();
			pageNo = 0;
			loadData();
			// 重新绑定上拉加载
			$.attachInfiniteScroll($content);
			$('.infinite-scroll-preloader').css("display", "block");
		}
	});

	$.init();

	loadData();

	openIndicator();

	function loadData() {

		pageNo = pageNo + 1;
		
		var postdata = { 'interId': 'toc.getOrderDetailForPageList', 'channel': 'C', 'pageNo': pageNo, 'pageSize': pageSize, 'custId': custId, 'orderStatus': orderStatus,'cancelStatus':cancelStatus };
		xhq.__runXHQ(postdata, function (data) {
		
			if (data.status == 0) {
				if (data.body) {
					//转化订单详情
					var obj = dataBodyToOrderList(data);
                    
					var html = "";
					//加载数据
					if(pageNo==1&&obj.length==0){
						
						$("#tabContent").html(nullHtml(html))
						
						$.detachInfiniteScroll($content);
						$('.infinite-scroll-preloader').remove();
						hideIndicator();
						return;
					}
					
					for (var i = 0; i < obj.length; i++) {
						var order = obj[i];
						if (order.orderStatus == '1' && order.cancelStatus == '1') {
							//待支付
							html = html + waitPayHtml(order)
						} else if (order.orderStatus == '2' && order.cancelStatus == '1') {
							//待发货
							html = html + waitDeliverHtml(order)
						} else if (order.orderStatus == '4' && order.cancelStatus == '1') {
							//已发货
							html = html + deliverHtml(order)
						} else if (order.orderStatus == '5' && order.cancelStatus == '1') {
							//已完成
							html = html + finishHtml(order)
						} else if (order.orderStatus == '6' && order.cancelStatus == '1') {
							//已关闭
							html = html + closeHtml(order)
						}else if (order.cancelStatus == '3'){
							//已退货
							html = html + refundHtml(order)
						}
					}

					if (pageNo == 1) {
						//覆盖
						$("#tabContent").html(html)
					} else {
						//追加
						$("#tabContent").append(html)
					}

					// 当数据已全部加载完成，则不允许上拉加载
					if (!data.body || data.body.length < pageSize) {
						$.detachInfiniteScroll($content);
						$('.infinite-scroll-preloader').remove();
					}
					loading = false;
				}else{
					$("#tabContent").html(nullHtml(html))
					
					$.detachInfiniteScroll($content);
					$('.infinite-scroll-preloader').remove();
					hideIndicator();
					return;
				}

				hideIndicator();
			} else {
				$.toast(data.message);
				hideIndicator();
			}
		})
	}

	function dataBodyToOrderList(data) {
		var obj = [];
		for (var i = 0; i < data.body.length; i++) {
			var boydata = data.body[i];
			var orderList = {};
			orderList.orderId = boydata.orderId;
			orderList.custName = boydata.custName;
			orderList.orderStatus = boydata.orderStatus;
			orderList.cancelStatus = boydata.cancelStatus;
			
			var list = boydata.orderDetails.split("|");
			var orderDetailList = [];
			for (var j = 0; j < list.length; j++) {
				var detail = list[j].split(",");
				var orderDetail = {};
				for (var k = 0; k < detail.length; k++) {
					var kv = detail[k].split("#");
					if (kv[0] == 'orderDetailId') {
						orderDetail.orderDetailId = kv[1];
					} else if (kv[0] == 'orderId') {

						orderDetail.orderId = kv[1];
					} else if (kv[0] == 'showName') {
						orderDetail.showName = kv[1];
					} else if (kv[0] == 'purchasePrice') {
						orderDetail.purchasePrice = kv[1];
					} else if (kv[0] == 'salePrice') {
						orderDetail.salePrice = kv[1];
					} else if (kv[0] == 'num') {
						orderDetail.num = kv[1];
					} else if (kv[0] == 'bigPic') {
						orderDetail.bigPic = kv[1];
					} else if(kv[0] == 'cancelStatus'){
						orderDetail.cancelStatus = kv[1];
					}
				}
				orderDetailList.push(orderDetail);
			}
			orderList.orderDetailList = orderDetailList;
			obj.push(orderList);
		}
		return obj;
	}
	
	function nullHtml(html){
		html += '<div class="content-block-2">';
		html += '<img src="../img/empty@3x.png" alt="">';
		html += '<p>还没有相关的订单呢</p >';
		html +=  '</div>';
		return html;
	}

	function orderDetailList(orderDetailList, html) {

		for (var i = 0; i < orderDetailList.length; i++) {

			var orderDetail = orderDetailList[i];
			html += '<div class="list-block media-list">';
			html += '<ul>';
			html += '<li>';
			html += '<a href="#" class="item-link item-content">';
			html += '<div class="item-media"><img src=' + orderDetail.bigPic + ' style="width: 3.5rem;height:3.5rem;">';
			if(orderDetail.cancelStatus=='3'){
				html += '<div><img src="../img/icon_tui.png" alt=""></div>';
			}
			html += '</div>';
			html += '<div class="item-title-row">';
			html += '<div class="item-text">' + orderDetail.showName + '</div>';
			html += '<div class="item-after">￥<span>' + orderDetail.salePrice/100 + '</span></div>';
			if(orderDetail.purchasePrice!='' && orderDetail.purchasePrice!='0'){
				html += '<div class="item-after1">￥<span>' + orderDetail.purchasePrice/100 + '</span></div>'
			}
			html += '<div class="item-after2">x<span>' + orderDetail.num + '</span></div>';
			html += '<div class="item-subtitle"></div>';
			html += '</div></a></li></ul></div>'
		}

		return html;
	}

	//待支付
	function waitPayHtml(order) {

		html = '<div class="content-block-1" orderId=' + order.orderId + ' orderStatus='+order.orderStatus+' cancelStatus='+order.cancelStatus+'><div class="order_box">';
		html += '<div class="order-address">';
		html += '<span>收货人: ' + order.custName + '</span> <button>待支付</button>';
		html += '</div>';
		html = orderDetailList(order.orderDetailList, html);
		html += '<div class="order-function">';
		html += '<button class="pay" style=" color: rgba(222,63,55,1);">付款</button>';
		html += '<button class="cancel-order">取消订单</button>';
		html += '</div>';
		html += '</div></div>';
		return html;
	}

	//待发货
	function waitDeliverHtml(order) {
		html = '<div class="content-block-1" orderId=' + order.orderId + ' orderStatus='+order.orderStatus+' cancelStatus='+order.cancelStatus+'><div class="order_box">'
		html += '<div class="order-address">';
		html += '<span>收货人: ' + order.custName + '</span> <button>待发货</button>';
		html += '</div>';
		html = orderDetailList(order.orderDetailList, html);
		html += '</div></div>';
		return html
	}

	//已发货
	function deliverHtml(order) {
		html = '<div class="content-block-1" orderId=' + order.orderId + ' orderStatus='+order.orderStatus+' cancelStatus='+order.cancelStatus+'><div class="order_box">';
		html += '<div class="order-address">'
		html += '<span>收货人: ' + order.custName + '</span> <button>已发货</button>';
		html += '</div>';
		html = orderDetailList(order.orderDetailList, html)
		html += '<div class="order-function">'
		html += '<button class="order-zhui order-signin--1">确认签收</button>';
		html += '<button class="order-zhui order-signin--2">追踪物流</button>';
		html += '</div>';
		html += '</div></div>';
		return html;
	}

	//已完成
	function finishHtml(order) {

		html = '<div class="content-block-1" orderId=' + order.orderId + ' orderStatus='+order.orderStatus+' cancelStatus='+order.cancelStatus+'><div class="order_box">';
		html += '<div class="order-address">';
		html += '<span>收货人: ' + order.custName + '</span> <button>已完成</button>';
		html += '</div>';
		html = orderDetailList(order.orderDetailList, html);
		html += '</div></div>';
		return html;
	}

	//已关闭
	function closeHtml(order) {
		html = '<div class="content-block-1" orderId=' + order.orderId + ' orderStatus='+order.orderStatus+' cancelStatus='+order.cancelStatus+'><div class="order_box">';
		html += '<div class="order-address">';
		html += '<span>收货人: ' + order.custName + '</span> <button>已关闭</button>';
		html += '</div>';
		html = orderDetailList(order.orderDetailList, html);
		html += '</div></div>';
		return html;
	}
	
	//已完成
	function refundHtml(order) {
		html = '<div class="content-block-1" orderId=' + order.orderId + ' orderStatus='+order.orderStatus+' cancelStatus='+order.cancelStatus+'><div class="order_box">';
		html += '<div class="order-address">';
		html += '<span>收货人: ' + order.custName + '</span> <button>已退货</button>';
		html += '</div>';
		html = orderDetailList(order.orderDetailList, html);
		html += '</div></div>';
		return html;
	}
	
	//取消订单,数据需要写
	$("#tabContent").on("click", ".cancel-order", function () {
		var orderId = $(this).parents(".content-block-1").attr("orderId")
		var that = $(this)
		$.confirm('确定要取消订单吗？', function () {
			
			var postdata = { 'interId': 'toc.closeOrder', 'channel': 'C', 'orderId': orderId,'custId':custId};
			xhq.__runXHQ(postdata, function (data) {
				if (data.status == 0) {
					 if(orderStatus==''){
						 xhq.gotoUrl('../html/order_list.html');
					 }
					 that.parents(".content-block-1").remove()
				}else{
					$.toast(data.message);
				}
			})
		})
		
	})

	// 付款
	$("#tabContent").on("click", ".pay", function () {
		var orderId = $(this).parents(".content-block-1").attr("orderId")
    	
    	var custId = getLocalSession("custId")||""
    	if (custId == ""){
    		$.toast("未获取到用户资料，无法访问");
    		xhq.gotoErrorPage();
    		return;
    	}
    			
    	var postdata = { 'interId': 'toc.getPayCode', 'channel': 'C', 'orderId': orderId,'custId':custId};
    	xhq.__runXHQ(postdata, function (data) {
    				if (data.status == 0) {
    					
    					var payConfig = {};
    					payConfig['appId'] = data.body.weiData.appId;
    					payConfig['nonceStr'] = data.body.weiData.nonceStr.toString();
    					payConfig['package'] = data.body.weiData.packageInfo;
    					payConfig['paySign'] = data.body.weiData.paySign;
    					payConfig['timeStamp'] = data.body.weiData.timeStamp+'';
    		            
    					var orderNo = data.body.orderNo;
    					xhq.wxPay(payConfig, function (res) {
    						xhq.gotoUrl('../html/paysuccess.html',{orderNo:orderNo});
    					},function(){
    						xhq.gotoUrl('../html/order_list.html');
    					});
    					
    				}else{
    					$.toast(data.message);
    				}
    			})

    	

	})
	// 确认签收
	$("#tabContent").on("click", ".order-signin--1", function () {
		
		var orderId = $(this).parents(".content-block-1").attr("orderId")
		var custId = getLocalSession("custId")||""
		var that = $(this)
        var postdata = { 'interId': 'toc.sureOrder', 'channel': 'C', 'orderId': orderId,'custId':custId};
			xhq.__runXHQ(postdata, function (data) {
				if (data.status == 0) {
					if(orderStatus==''){
						 xhq.gotoUrl('../html/order_list.html');
					}
					that.parents(".content-block-1").remove()
					var html = $("#tabContent").html()
					if(html.length==0){
						$("#tabContent").html(nullHtml(html))
					}
				}else{
					$.toast(data.message);
				}
		})
	})
	
	// 追踪物流 == 跳转详情页
	$("#tabContent").on("click", ".order-signin--2", function () {
		var orderId = $(this).parents(".content-block-1").attr("orderId")
		var orderStatus = $(this).parents(".content-block-1").attr("orderStatus")
		var cancelStatus = $(this).parents(".content-block-1").attr("cancelStatus")
		
		var url = "order_detail.html"
		if(orderStatus=='1' && cancelStatus=='1'){
			url = "order_wait_pay.html"
		}else if(orderStatus=='2' && cancelStatus=='1'){
			url = "order_wait_deliver.html"
		}else if(orderStatus=='4' && cancelStatus=='1'){
			url = "order_deliver.html"
		}else if(orderStatus=='5' && cancelStatus=='1'){
			url = "order_finish.html"
		}else if(orderStatus=='6' && cancelStatus=='1'){
		    url = "order_close.html"
		}else{
			url = "order_refund.html"
		}
		xhq.gotoUrl(url,{orderId:orderId})
	})

	//   跳转详情页
	$("#tabContent").on("click", ".list-block", function () {

		var orderId = $(this).parents(".content-block-1").attr("orderId")
		var orderStatus = $(this).parents(".content-block-1").attr("orderStatus")
		var cancelStatus = $(this).parents(".content-block-1").attr("cancelStatus")
		var url = "order_detail.html"
		if(orderStatus=='1' && cancelStatus=='1'){
			url = "order_wait_pay.html"
		}else if(orderStatus=='2' && cancelStatus=='1'){
			url = "order_wait_deliver.html"
		}else if(orderStatus=='4' && cancelStatus=='1'){
			url = "order_deliver.html"
		}else if(orderStatus=='5' && cancelStatus=='1'){
			url = "order_finish.html"
		}else if(orderStatus=='6' && cancelStatus=='1'){
		    url = "order_close.html"
		}else{
			url = "order_refund.html"
		}
		xhq.gotoUrl(url,{orderId:orderId,cancelStatus:cancelStatus})

	})
	
	function close(){
		var orderId = $("input").attr("orderId")
		$.confirm('确定要取消订单吗？', function () {
			
			var postdata = { 'interId': 'toc.closeOrder', 'channel': 'C', 'orderId': orderId,'custId':custId};
			xhq.__runXHQ(postdata, function (data) {
				if (data.status == 0) {
					xhq.gotoUrl(order_close.html,{orderId:orderId})
				}else{
					$.toast(data.message);
				}
			})
		})
	}

})
	
