var avoidExpressFee = 0;//免邮费
var expressFee = 0;//邮费
var deliverSureDay = 7;//延迟天数

function openIndicator() {
	$.showIndicator();
	isIndicator = true;
}

function hideIndicator() {
	if (isIndicator) {
		$.hideIndicator();
		isIndicator = false;
	}
	loading = false;
}

// 1页面加载逻辑
// 1.1加载购物车缓存
$(document).ready(function () {

	// 校验openid
	var openId = getLocalSession("openid") || "";
	// 校验openid
	var custId = getLocalSession("custId") || "";
	
	if (openId == "" || custId==""){
		$.toast("未获取到用户信息，无法访问");
		xhq.gotoErrorPage();
		return;
	}
	
	openIndicator();
	//加载标题
	var param = { interId: 'toc.getAvoidExpressFee', channel: 'C' };
	xhq.__runXHQ(param, function (data) {
		if (data.status == 0) {
			avoidExpressFee = data.body.avoidExpressFee
			expressFee = data.body.expressFee;
			deliverSureDay = data.body.cancelDelday
			if(avoidExpressFee==0){
				$("#adtOrderTitle").html(deliverSureDay + "天无忧退货  全场包邮");
			}
			//加载地址
			loadAddress()
			//加载订单
		    loadOrder()
			hideIndicator();
			bindEvent();
		} else {
			$.toast(data.message);
		}
	})
	
})

function loadOrder(){
	var data = getLocalSession("localOrderSession")
	console.log("localOrderSession"+JSON.stringify(data))
	//alert()
	if(data==null||data==''||data==undefined){
		xhq.gotoUrl('home.html')
		return;
	}else{
		var mailList = $("#mailList").html()
		var body = JSON.parse(data)
		if (body.length > 0) {
			for (var i = 0; i < body.length; i++) {
				var obj = body[i];
				mailList += '<div class="list1"><hr>';
				mailList += '<div class="list1-img"><img src="' + obj.bigPic + '" alt=""></div>';
				mailList += '<div class="list1-wenzi">';
				mailList += '<p>' + obj.showName + '</p>';
				mailList += '<span class="bargain-price price" salePrice=' + obj.salePrice + '>' + obj.salePrice / 100 + '</span>';
				mailList += '<span class="youfei" style="display:none;" mailMoney=' + obj.mailMoney + '>' + obj.mailMoney + '</span><span num=' + obj.num + ' class="img">' + obj.num + '</span>';
				mailList += '<p class="norms1"></p>';
				mailList += '</div>';
				mailList += '</div>';
			}
			$("#mailList").html(mailList);
		}
	}
}

function loadAddress(){
	//setLocalSession("localAddressSession","");
	//获取默认地址
	var localAddressSession = getLocalSession("localAddressSession");
	var addressHtml=$(".content-block2").html();
	//地址信息
	if(localAddressSession==null || localAddressSession ==undefined || localAddressSession==''){
		queryDefaultAddressOrSetLocalAddress();
	}else{
		setAddressInfo(localAddressSession)
	}
}

function setAddressInfo(addressSession){
	var data = JSON.parse(addressSession);
	if(data.length==0){
		$(".content-block2").html(nullAddressHtml(addressHtml))
	}else{
		var province = data.province || '';
		var city = data.city || '';
		var country = data.country || '';
		var addressDetail = province + data.city+country;
		addressDetail= addressDetail + data.address;
		var addressName = data.addressName;
		var addressPhoneNo = data.phoneNo;
 	    var phoneNoStr = addressPhoneNo.replace(addressPhoneNo.substr(3,7),"****");
 	  
		var addressId = data.addressId;
		
	    var addressHtml='<div addressId = "'+addressId+'">';
	    addressHtml+='<span id="addressName">'+addressName+'</span> <span class="phone" id="addressPhoneNo">'+phoneNoStr+'</span>';
	    addressHtml+='<p><span id="moren">默认</span> <span class="attr phone" id="addressDetail">'+addressDetail+'</span></p>'
	    addressHtml+='</div>';
	    addressHtml+='<div> <img class="img" src="../img/icoJiantou@2x.png" alt=""></div>';
	    $(".content-block2").append(addressHtml)
	}
}

function queryDefaultAddressOrSetLocalAddress(){
	
	var custId = getLocalSession("custId") || "";
	var param = {};
	param.interId = 'toc.getCustDefaultAddress';
	param.channel = "C";
	param.custId = custId;
	xhq.__runXHQ(param, function (data) {
		if(data.status=='0'){
			if(data.body){
				 var obj = {
		                    addressId: data.body.id,
		                    addressName: data.body.name,
		                    phoneNo: data.body.phoneNo,
		                    province: data.body.province,
		                    city: data.body.city,
		                    country: data.body.country,
		                    address: data.body.address,
		                    defaultFlag: data.body.defaultFlag
		                }
		         setLocalSession("localAddressSession", JSON.stringify(obj))
		         setAddressInfo(JSON.stringify(obj));
			}else{
				 $(".content-block2").append(nullAddressHtml())
			}
		}else{
			$.alert(data.message);
		}
	})
	
}

function nullAddressHtml(){
	    var addressHtml='<div style="position:absolute;top:34pt;font-size:0.85rem;width:90vw;">';
	    addressHtml+='<img style="width:16pt;height:16pt;vertical-align:middle;position: relative;top: -1pt;" src="../img/oval@2x.png" alt="">'
	    addressHtml+='<span style="padding-left:5pt;color:rgb(0,0,0)">你还未添加收货地址</span> <span style="position:absolute;top:0pt;right:20pt;color:rgb(222, 63, 55)">去添加</span>'
	    addressHtml+='</div> <div> <img class="img" src="../img/icoJiantou@2x.png" alt=""></div>'
	  return addressHtml;
}

function bindEvent() {
	
	$("#goback").click(function(){
		window.history.go(-1)
	})
	// 点击修改地址，需要修改
	$(".content-block2").click(function () {
		var addressSession = getLocalSession("localAddressSession");
		if(addressSession==null || addressSession ==undefined || addressSession==''){
			window.location.href = "../html/address_register.html?type=2&pageType=1"
		}else{
			window.location.href = "../html/address_list.html?pageType=1"
		}
		
	})
	// 商品合计 
	var originalPrice = 0;
	var totalMailMoney = 0;
	$(".list1").each(function () {
		var salePrice = $(this).find(".list1-wenzi  .price").attr("salePrice")
		var num = $(this).find(".list1-wenzi  .img").attr("num")
		originalPrice += salePrice * num;
	})

	$("#originalPrice").text(function () {
		return (parseFloat(originalPrice)/100).toString()
	});
	
	$("#avoidExpressFee1").text(function(){
		
		return (parseFloat(avoidExpressFee)/100).toString()
	}
    );
    
	$("#expressFee1").text(function () {
		if (parseFloat(originalPrice) >= parseFloat(avoidExpressFee)) {
			return (0).toString()
		} else {
			return (parseFloat(expressFee)/100).toString()
		}
	});

	//实付
	$("footer p .price").text(function () {
		if (parseFloat(originalPrice) >= parseFloat(avoidExpressFee)) {
			return (parseFloat(originalPrice)/100).toString()
		} else {
			return ((originalPrice + parseFloat(expressFee))/100).toString()
		}
	});
	// 关闭广告
	$(".content-block .content-block1 img").click(function () {
		$(".content-block1").hide()
	});

	// 去付款
	$(".xia").click(function () {
		$(this).addClass('none');  //点击下单 按钮变灰且不可点击
		openIndicator();
		// 校验openid
		var openId = getLocalSession("openid") || "";
		// 校验custId
		var custId = getLocalSession("custId") || "";
		
		var sourceId =  xhq.getQuery("sourceId") || "";//来源id
		var sourceType =  xhq.getQuery("sourceType") || "3";//下单来源 1活动 2分享 3平台下单 4参团
		var channelType = xhq.getQuery("channelType") || "1";//订单渠道类型 1通用上架  2一元置换 3积分兑换 4参团
		var groupId = xhq.getQuery("groupId") || "";//参团id
		var addressId = $(".content-block2").find("div").eq(0).attr("addressId")||'';
		
		if (openId == "" || custId==""){
			hideIndicator();
			$.toast("未获取到用户信息，无法访问");
			xhq.gotoErrorPage();
			return;
		}
		if(channelType==""){
			hideIndicator();
			$(this).removeClass('none');
			$.toast("订单渠道类型不能为空，无法访问");
			return;
		}
		if(channelType=='4' && groupId==""){
			hideIndicator();
			$(this).removeClass('none');
			$.toast("参团信息不能为空");
			return;
		}

		if(addressId=='' || addressId==undefined || addressId==null){
			hideIndicator();
			$(this).removeClass('none');
			$.toast("用户地址信息不能为空");
			return;
		}
		
		var orderDetails = JSON.parse(getLocalSession("localOrderSession"));
		var obj = {};
		obj.interId = 'toc.createOrder';
		obj.channel = "C";
		obj.custId = custId;
		obj.addressId = addressId;
		obj.remark = $("#remark").val();
		obj.expressFee = parseFloat($("#expressFee1").text()*100).toFixed(0)
		obj.totalNum = "" //商品总数量
		obj.realPay = parseFloat($("#realPay").text()*100).toFixed(0)
		obj.shippingModel = 2////1. 自提 2.寄送 3.上门自提,目前默认为2
		obj.details = orderDetails;
		obj.sourceId =  sourceId;//来源id
		obj.sourceType =  sourceType;//下单来源 1活动 2分享 3平台下单 4参团
		obj.channelType = channelType;//订单渠道类型 1通用上架  2一元置换 3积分兑换 4参团
		obj.groupId = groupId;//参团id
		var that = $(this);
		var param = obj;
		xhq.__runXHQ(param, function (data) {
			
			if(data.status==0){
				//需要把购物车里面购买的商品清空
				var mallType = xhq.getQuery("mallType")||"";
				var payConfig = {};
				payConfig['appId'] = data.body.weiData.appId;
				payConfig['nonceStr'] = data.body.weiData.nonceStr.toString();
				payConfig['package'] = data.body.weiData.packageInfo;
				payConfig['paySign'] = data.body.weiData.paySign;
				payConfig['timeStamp'] = data.body.weiData.timeStamp+'';
	            
				var orderNo = data.body.orderNo;
				var groupId = data.body.groupId || "";
				var channelType = data.body.channelType;
				//alert(orderNo+"groupId"+groupId);
				xhq.wxPay(payConfig, function (res) {
					hideIndicator();
					//把下单缓存清空
					setLocalSession("localOrderSession", "");
					//从购物车按钮下单的，清除购物车商品信息
					if(mallType=='gwcgm'){
						var unCheckShoppingCartLocalSession = getLocalSession("unCheckShoppingCartLocalSession");
						if(unCheckShoppingCartLocalSession!=null && unCheckShoppingCartLocalSession != undefined && unCheckShoppingCartLocalSession!=''){
							setLocalSession("shoppingCartLocalSession", unCheckShoppingCartLocalSession)
						}
					}
					
					if(channelType=='4'){
						xhq.gotoUrl('../html/tour_successful.html',{orderNo:orderNo,channelType:channelType,groupId:groupId});
					}else{
						xhq.gotoUrl('../html/paysuccess.html',{orderNo:orderNo,channelType:channelType,groupId:groupId});
					}
				},function(){
					hideIndicator();
					$.toast("支付失败");
					xhq.gotoUrl('../html/order_list.html');
				});
			}else{
				hideIndicator();
				$.alert(data.message);
				that.removeClass('none');
			}
		});
	})
	
	//删除下单的购物车商品信息
//	function deleteShoppingCartLocalSession(orderDetails) {
//		
//		var cartSS = getLocalSession("shoppingCartLocalSession");
//		if(orderDetails!=null && orderDetails !='' && cartSS!=null && cartSS!='' && cartSS!=undefined){
//			var cartSession = JSON.parse(getLocalSession("shoppingCartLocalSession"));
//			for(var j=0;j<orderDetails.length;j++){
//					var onlineId = orderDetails[j].onlineId
//					for (var i = 0; i < cartSession.body.length; i++) {
//						if (cartSession.body[i].onlineId == onlineId) {
//								cartSession.body.splice(i, 1);
//								if (cartSession.body.length == 0) {
//									cartSession = "";
//								}
//								break;
//						}
//					}
//			}
//			setLocalSession("shoppingCartLocalSession", JSON.stringify(cartSession));
//		}
//	}
}
